<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calo Tracker AI</title>
    <link rel="stylesheet" href="style.css">
    <!-- Thư viện Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Thư viện Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS cho thông báo Toast đẹp mắt */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #fff;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            border-left: 5px solid #4CAF50;
            animation: slideIn 0.3s ease-out forwards, fadeOut 0.5s ease-in 4.5s forwards;
        }
        .toast.warning { border-left-color: #FF9800; }
        .toast i { font-size: 1.4em; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- MÀN HÌNH ĐĂNG NHẬP / ĐĂNG KÝ -->
        <div id="auth-view">
            <div style="text-align:center; margin-top: 50px; margin-bottom: 30px;">
                <h1 style="color:var(--primary-dark); font-size: 28px;">Calo Tracker</h1>
                <p style="color:#666;">Đăng nhập để đồng bộ dữ liệu</p>
            </div>

            <div class="card" style="margin: 20px;">
                <h3 id="auth-title">Đăng nhập</h3>
                <!-- Thêm thẻ form và autocomplete để sửa lỗi DOM warning -->
                <form onsubmit="event.preventDefault();">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="auth-email" placeholder="email@example.com" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Mật khẩu</label>
                        <input type="password" id="auth-password" placeholder="******" autocomplete="current-password">
                    </div>
                    
                    <button type="button" class="btn-primary" id="btn-auth-action" onclick="handleLogin()">Đăng nhập</button>
                </form>
                
                <p style="text-align:center; margin-top:15px; font-size:13px;">
                    <span id="auth-switch-text">Chưa có tài khoản?</span> 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary); font-weight:bold;">Bấm vào đây</a>
                </p>
                <p id="auth-error" style="color:red; font-size:12px; text-align:center; margin-top:10px; display:none;"></p>
            </div>
        </div>

        <!-- GIAO DIỆN CHÍNH (Ẩn mặc định) -->
        <div id="app-view" class="hidden" style="display:flex; flex-direction:column; height:100%;">

        <!-- Header -->
        <header>
            <h1>Calo Tracker</h1>
            <div class="summary-bar">
                <span>Mục tiêu: <b id="target-kcal">--</b></span>
            </div>
        </header>

        <!-- Nội dung chính -->
        <main id="main-content">
            
            <!-- TAB 1: TRANG CHỦ -->
            <section id="tab-home" class="active-tab">
                <!-- Vòng tròn tiến độ -->
                <div class="progress-card">
                    <div class="circle-progress">
                        <div class="inner-circle">
                            <span id="remaining-kcal">0</span>
                            <small>Còn lại</small>
                        </div>
                    </div>
                    <div class="stats-row">
                        <div>Đã nạp: <span id="consumed-kcal">0</span></div>
                        <div>Đã đốt: <span id="burned-kcal">0</span></div> <!-- Tạm tính cơ bản -->
                    </div>
                    <div class="stats-row" style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">
                        <div>BMI: <span id="disp-bmi" style="font-weight:bold; color:#333">--</span></div>
                        <div>BMR: <span id="disp-bmr" style="font-weight:bold; color:#333">--</span></div>
                        <div>WHtR: <span id="disp-whtr" style="font-weight:bold; color:#333">--</span></div>
                    </div>
                </div>

                <!-- Nhập thức ăn -->
                <div class="card">
                    <h3>Nạp năng lượng</h3>
                    <div class="search-box" style="position: relative;">
                        <input type="text" id="food-name" placeholder="Bạn vừa ăn gì?" autocomplete="off">
                        <button onclick="searchFood()"><i class="fas fa-search"></i></button>
                        <ul id="food-suggestions" class="suggestions-list hidden"></ul>
                    </div>
                    
                    <!-- Kết quả tìm kiếm / Nhập tay -->
                    <div id="food-result" class="hidden">
                        <p class="result-title">Món: <b id="res-name"></b></p>
                        
                        <div class="input-group" style="align-items: flex-start;">
                            <label style="margin-top: 12px;">Kcal/100g:</label>
                            <div style="flex:1;">
                                <input type="number" id="res-kcal-unit" placeholder="Nhập số liệu">
                                <!-- Dòng thông báo tinh tế nằm ngay dưới ô nhập -->
                                <small id="auto-estimate-msg" class="hidden" style="color: #f57c00; font-size: 11px; margin-top: 4px; display: block;">
                                    <i class="fas fa-magic"></i> Ước tính tự động
                                </small>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Khối lượng (g):</label>
                            <input type="number" id="res-weight" value="100">
                        </div>
                        
                        <button class="btn-primary" onclick="addFoodToLog()">Thêm vào nhật ký</button>
                    </div>
                </div>

                

                <!-- Vận động -->
                <div class="card">
                    <h3>Vận động hôm nay</h3>
                    <div class="input-group">
                        <label>Hoạt động:</label>
                        <input type="text" id="activity-name" placeholder="Chạy bộ" oninput="suggestActivityRate()">
                    </div>
                    <div class="input-group">
                        <label>Kcal/30p:</label>
                        <input type="number" id="activity-rate" placeholder="150" oninput="previewActivityKcal()">
                    </div>
                    <div class="input-group" style="align-items: flex-start;">
                        <label style="margin-top: 12px;">Thời gian (phút):</label>
                        <div style="flex:1;">
                            <input type="number" id="activity-duration" placeholder="30" oninput="previewActivityKcal()">
                            <small id="activity-est-msg" class="hidden" style="color: #e53935; font-size: 11px; margin-top: 4px; display: block;">
                                <i class="fas fa-fire"></i> Ước tính đốt: <b id="preview-burned">0</b> kcal
                            </small>
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="addActivityToLog()">Thêm vận động</button>
                </div>

                <!-- Danh sách hôm nay -->
                <div class="card">
                    <h3>Hôm nay thế nào?</h3>
                    <ul id="today-list" class="food-list">
                        <!-- Item sẽ được thêm bằng JS -->
                    </ul>
                </div>
            </section>

            <!-- TAB 2: LỊCH SỬ -->
            <section id="tab-history">
                <ul id="history-list" class="food-list">
                    <!-- Item lịch sử -->
                </ul>
            </section>

            <!-- TAB 4: BIỂU ĐỒ -->
            <section id="tab-charts">
                <h2>Theo dõi chỉ số</h2>
                <div class="card">
                    <canvas id="weightChart"></canvas>
                    <p style="text-align:center; font-size:12px; color:#666; margin-top:10px;">Biểu đồ thay đổi cân nặng theo thời gian</p>
                </div>
            </section>

            <!-- TAB 3: CẤU HÌNH -->
            <section id="tab-settings">
                <h2>Cài đặt chỉ số</h2>
                <div class="card">
                    <form id="settings-form">
                        <div class="form-group">
                            <label>Ngày ghi nhận</label>
                            <input type="date" id="set-date">
                        </div>

                        <div class="form-group">
                            <label>Cân nặng (kg)</label>
                            <input type="number" id="set-weight" placeholder="VD: 70">
                        </div>
                        
                        <div class="form-group">
                            <label>Chiều cao (cm)</label>
                            <input type="number" id="set-height" placeholder="VD: 170">
                        </div>
                        
                        <div class="form-group">
                            <label>Vòng eo (cm)</label>
                            <input type="number" id="set-waist" placeholder="VD: 75">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Tuổi</label>
                                <input type="number" id="set-age" placeholder="VD: 25">
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Giới tính</label>
                                <select id="set-gender">
                                    <option value="male">Nam</option>
                                    <option value="female">Nữ</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mức độ vận động</label>
                            <select id="set-activity">
                                <option value="1.2">Ít vận động (Văn phòng)</option>
                                <option value="1.375">Nhẹ (1-3 ngày/tuần)</option>
                                <option value="1.55">Vừa (3-5 ngày/tuần)</option>
                                <option value="1.725">Nhiều (6-7 ngày/tuần)</option>
                            </select>
                        </div>

                        <button type="button" class="btn-primary" onclick="saveSettings()">Lưu & Tính TDEE</button>
                        
                        <button type="button" class="btn-secondary" onclick="openGuideModal()" style="background:#607D8B; margin-top:10px;">
                            <i class="fas fa-book"></i> Hướng dẫn sử dụng
                        </button>

                        <button type="button" class="btn-secondary" onclick="handleLogout()" style="background:#e53935; margin-top:20px;">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </button>
                    </form>
                </div>
            </section>

        </main>

        <!-- Menu dưới cùng -->
        <nav class="bottom-nav">
            <button onclick="switchTab('tab-home')" class="nav-btn active">
                <i class="fas fa-home"></i><span>Home</span>
            </button>
            <button onclick="switchTab('tab-history')" class="nav-btn">
                <i class="fas fa-history"></i><span>Lịch sử</span>
            </button>
            <button onclick="switchTab('tab-charts')" class="nav-btn">
                <i class="fas fa-chart-line"></i><span>Biểu đồ</span>
            </button>
            <button onclick="switchTab('tab-settings')" class="nav-btn">
                <i class="fas fa-user-cog"></i><span>Cấu hình</span>
            </button>
        </nav>
        </div> <!-- End #app-view -->
    </div>

    <!-- MODAL CHỈNH SỬA (Ẩn mặc định) -->
    <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Chỉnh sửa</h3>
            <p id="edit-item-name" style="color:var(--primary-dark); font-weight:bold; margin-bottom:15px;"></p>
            
            <div class="input-group">
                <label id="edit-label">Số lượng:</label>
                <input type="number" id="edit-quantity">
            </div>
            
            <!-- Lưu trữ ID và Type ẩn -->
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-type">

            <button class="btn-primary" onclick="saveEditItem()">Lưu thay đổi</button>
            <button class="btn-secondary" onclick="deleteItem()" style="background:#e53935; margin-top:10px;">Xóa mục này</button>
            <button class="btn-secondary" onclick="closeEditModal()" style="background:#757575; margin-top:10px;">Hủy</button>
        </div>
    </div>

    <!-- MODAL HƯỚNG DẪN SỬ DỤNG -->
    <div id="guide-modal" class="modal hidden">
        <div class="modal-content" style="max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">Hướng dẫn sử dụng</h3>
            
            <!-- Khu vực nội dung có thể cuộn -->
            <div style="overflow-y: auto; text-align: left; margin: 10px 0; padding-right: 5px; line-height: 1.6; font-size: 14px; color: #333;">
                <p><strong>1. Trang chủ (Home):</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 10px;">
                    <li><b>Nạp năng lượng:</b> Nhập tên món ăn. Hệ thống sẽ gợi ý nếu món đã có, hoặc tự ước tính calo nếu món mới.</li>
                    <li><b>Vận động:</b> Nhập hoạt động và thời gian tập luyện để trừ bớt calo dư thừa.</li>
                    <li><b>Hôm nay thế nào:</b> Xem lại danh sách đã nhập. Bấm vào từng mục để <i>Sửa</i> hoặc <i>Xóa</i>.</li>
                </ul>

                <p><strong>2. Chỉ số cơ thể:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 10px;">
                    <li><b>TDEE:</b> Tổng năng lượng bạn tiêu hao mỗi ngày. Ăn ít hơn số này để giảm cân.</li>
                    <li><b>Vòng tròn màu:</b> Xanh lá (An toàn) -> Đỏ (Vượt quá mức cho phép).</li>
                </ul>

                <p><strong>3. Lịch sử & Biểu đồ:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 10px;">
                    <li>Xem lại nhật ký ăn uống 30 ngày gần nhất.</li>
                    <li>Theo dõi biểu đồ cân nặng để thấy sự tiến bộ.</li>
                </ul>

                <p><strong>4. Ý nghĩa các chỉ số:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 10px;">
                    <li><b>BMI (Body Mass Index):</b> Đánh giá mức độ gầy/béo. <br><small><i>Dưới 18.5: Gầy | 18.5 - 22.9: Bình thường | Trên 23: Thừa cân.</i></small></li>
                    <li><b>BMR (Basal Metabolic Rate):</b> Năng lượng tối thiểu cơ thể cần để duy trì sự sống (thở, tim đập...) khi nghỉ ngơi hoàn toàn.</li>
                    <li><b>TDEE:</b> Tổng năng lượng tiêu hao thực tế trong ngày (BMR + Vận động). <br><small><i>Muốn giảm cân: Ăn < TDEE. Muốn tăng cân: Ăn > TDEE.</i></small></li>
                    <li><b>WHtR (Waist to Height):</b> Tỷ lệ Vòng eo / Chiều cao. <br><small><i>Đánh giá mỡ bụng chính xác hơn BMI. Lý tưởng là dưới 0.5.</i></small></li>
                </ul>

                <p><i>Mẹo: Hãy nhập liệu đều đặn để AI học thói quen của bạn tốt hơn!</i></p>
            </div>

            <button class="btn-secondary" onclick="closeGuideModal()" style="margin-top: 0;">Đóng</button>
        </div>
    </div>

    <!-- Container chứa các thông báo -->
    <div id="notification-container"></div>

    <!-- Firebase SDKs (Phiên bản Compat để dễ dùng cho web tĩnh) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- File Logic chính -->
    <script src="script.js"></script>
</body>
</html>
